name: AI Code Review
on:
  pull_request:
    types: [opened, synchronize] # PRì´ ì—´ë¦¬ê±°ë‚˜ ìƒˆë¡œìš´ ì»¤ë°‹ì´ í‘¸ì‹œë  ë•Œ ì‹¤í–‰

jobs:
  review:
    runs-on: ubuntu-latest
    steps:
      # 1. ì†ŒìŠ¤ ì½”ë“œë¥¼ ê°€ì ¸ì˜µë‹ˆë‹¤.
      - name: Checkout code
        uses: actions/checkout@v3
        with:
          fetch-depth: 0 # ëª¨ë“  íˆìŠ¤í† ë¦¬ë¥¼ ê°€ì ¸ì™€ì•¼ diff ë¹„êµê°€ ê°€ëŠ¥í•©ë‹ˆë‹¤.

      # 2. PRì˜ ë³€ê²½ì‚¬í•­(diff)ì„ íŒŒì¼ë¡œ ì €ì¥í•©ë‹ˆë‹¤.
      - name: Get PR diff
        run: |
          git diff ${{ github.event.pull_request.base.sha }} ${{ github.event.pull_request.head.sha }} > pr.diff

      # 3. AI APIë¥¼ í˜¸ì¶œí•˜ì—¬ ë¦¬ë·°ë¥¼ ìš”ì²­í•˜ê³  ê²°ê³¼ë¥¼ íŒŒì¼ë¡œ ì €ì¥í•©ë‹ˆë‹¤.
      - name: Request AI Review
        run: |
          # AIì—ê²Œ ë³´ë‚¼ í”„ë¡¬í”„íŠ¸ë¥¼ êµ¬ì„±í•©ë‹ˆë‹¤.
          PROMPT="ë‹¤ìŒ ì½”ë“œ ë³€ê²½ì‚¬í•­ì„ ë¦¬ë·°í•˜ê³ , ì ì¬ì ì¸ ë²„ê·¸ë‚˜ ê°œì„ ì ì— ëŒ€í•´ ì„¤ëª…í•´ì¤˜. \n\n\`\`\`diff\n$(cat pr.diff)\n\`\`\`"
          
          # curlì„ ì‚¬ìš©í•´ AI API í˜¸ì¶œ (ì—¬ê¸°ëŠ” ì‚¬ìš©í•˜ëŠ” AI ì„œë¹„ìŠ¤ì— ë§ê²Œ ìˆ˜ì • í•„ìš”)
          curl -X POST '${{ secrets.API_URL }}' \
            -H "Authorization: Bearer ${{ secrets.AI_API_KEY }}" \
            -H "Content-Type: application/json" \
            -d "{\"prompt\": \"${PROMPT}\", \"model\":ivy-4-mm \"text-davinci-003\"}" \
            | jq -r '.choices[0].text' > review_comment.txt # ì‘ë‹µì—ì„œ ë¦¬ë·° í…ìŠ¤íŠ¸ë§Œ ì¶”ì¶œ

      # 4. Gitea APIë¥¼ í†µí•´ PRì— ë¦¬ë·° ëŒ“ê¸€ì„ ì‘ì„±í•©ë‹ˆë‹¤.
      - name: Post Review Comment
        run: |
          COMMENT_BODY=$(cat review_comment.txt)
          curl -X POST \
            -H "Authorization: token ${{ secrets.GITEA_TOKEN }}" \
            -H "Content-Type: application/json" \
            -d "{\"body\": \"ğŸ¤– AI ì½”ë“œ ë¦¬ë·°:\n\n${COMMENT_BODY}\"}" \
            "${{ github.api_url }}/repos/${{ github.repository }}/issues/${{ github.issue.number }}/comments"